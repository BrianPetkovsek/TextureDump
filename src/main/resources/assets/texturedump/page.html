<html>
<head>
    <script lang="JavaScript">
        //FastDOM, minified
        !function(t){"use strict";function e(){var e=this;e.reads=[],e.writes=[],e.raf=u.bind(t)}function n(t){t.scheduled||(t.scheduled=!0,t.raf(i.bind(null,t)))}function i(t){var e,i=t.writes,o=t.reads;try{r(o),r(i)}catch(s){e=s}if(t.scheduled=!1,(o.length||i.length)&&n(t),e){if(!t["catch"])throw e;t["catch"](e)}}function r(t){for(var e;e=t.shift();)e()}function o(t,e){var n=t.indexOf(e);return!!~n&&!!t.splice(n,1)}function s(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])}var u=t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.mozRequestAnimationFrame||t.msRequestAnimationFrame||function(t){return setTimeout(t,16)};e.prototype={constructor:e,measure:function(t,e){var i=e?t.bind(e):t;return this.reads.push(i),n(this),i},mutate:function(t,e){var i=e?t.bind(e):t;return this.writes.push(i),n(this),i},clear:function(t){return o(this.reads,t)||o(this.writes,t)},extend:function(t){if("object"!=typeof t)throw new Error("expected object");var e=Object.create(this);return s(e,t),e.fastdom=this,e.initialize&&e.initialize(),e},"catch":null};var exports=t.fastdom=t.fastdom||new e;"f"==(typeof define)[0]?define(function(){return exports}):"o"==(typeof module)[0]&&(module.exports=exports)}("undefined"!=typeof window?window:this);


        var cellSize = {x: 16, y: 16};
        var cells = [];
        var lastCell;

        var modIdElement;
        var nameElement;
        var sizeElement;
        var markerElement;
        var imageElement;
        var sourceImageElement;
        var debugElement;

        function initialize() {
            cellSize = {x: 128, y: 128};

            var sheet = document.getElementById("sheet");

            var cellDimensions = {
                width: sheet.width / cellSize.x,
                height: sheet.height / cellSize.y
            };

            //Preallocate Cells for speed
            cells = [];
            for (var y = 0; y <= cellDimensions.height; ++y) {
                cells[y] = [];
                for (var x = 0; x <= cellDimensions.width; ++x) {
                    cells[y][x] = []
                }
            }

            //Add sprite indexes to all the cells they occupy
            var arrayLength = imageData.length;
            for (var i = 0; i < arrayLength; i++) {
                var sprite = imageData[i];
                if (sprite.name == "botania:blocks/alfheimPortalInside") {
                    console.log(sprite);
                }

                var cellY = Math.floor(sprite.y / cellSize.y);
                var cellsUsedY = Math.ceil((sprite.y + sprite.height) / cellSize.y);
                for (var y = 0; y < cellsUsedY; ++y) {
                    var cellX = Math.floor(sprite.x / cellSize.x);
                    var cellsUsedX = Math.ceil((sprite.x + sprite.width) / cellSize.x);
                    for (var x = 0; x < cellsUsedX; ++x) {
                        cells[cellY + y][cellX + x].push(i)
                    }
                }
            }

            //Pre-resolve elements that will be updated
            modIdElement = document.getElementById("modId");
            nameElement = document.getElementById("name");
            sizeElement = document.getElementById("size");
            markerElement = document.getElementById("marker");
            imageElement = document.getElementById("singleImage");
            debugElement = document.getElementById("debug");
            sourceImageElement = document.getElementById("sheet");

            document.getElementById("loading").style.display = "none";

            sheet.addEventListener("mousemove", onMouseMove);
        }

        function onMouseMove(eventInfo) {
            fastdom.measure(function() {
                var cellX = Math.floor(eventInfo.offsetX / cellSize.x);
                var cellY = Math.floor(eventInfo.offsetY / cellSize.y);

                if (cells[cellY] !== undefined && cells[cellY][cellX] !== undefined) {
                    var containedSprites = cells[cellY][cellX];
                    var imageDataIndex = -1;
                    for (var i = 0; i < containedSprites.length; ++i) {
                        var data = imageData[containedSprites[i]];
                        console.log(`Checking ${data.name}`);
                        if (eventInfo.offsetX >= data.x && eventInfo.offsetX <= data.x + data.width) {
                            if (eventInfo.offsetY >= data.y && eventInfo.offsetY <= data.y + data.height) {
                                imageDataIndex = containedSprites[i];
                                break;
                            }
                        }
                    }

                    if (imageDataIndex < 0) {
                        return;
                    }

                    if (imageDataIndex != lastCell) {
                        lastCell = imageDataIndex;
                        var data = imageData[imageDataIndex];

                        var targetTop = eventInfo.target.offsetTop;
                        var targetLeft = eventInfo.target.offsetLeft;

                        var imageElementWidth = imageElement.width;
                        var imageElementHeight = imageElement.height;

                        var ctx = imageElement.getContext("2d");
                        ctx.mozImageSmoothingEnabled = false;
                        ctx.msImageSmoothingEnabled = false;
                        ctx.imageSmoothingEnabled = false;

                        ctx.clearRect(0, 0, imageElementWidth, imageElementHeight);
                        ctx.drawImage(sourceImageElement,
                                data.x, data.y, data.width, data.height,
                                0, 0, imageElementWidth, imageElementHeight
                        );

                        fastdom.mutate(function() {
                            modIdElement.innerText = data.name.substring(0, data.name.indexOf(":"));
                            nameElement.innerText = data.name.substring(data.name.indexOf(":") + 1);
                            sizeElement.innerText = data.width + " x " + data.height;

                            markerElement.style.top = data.y + targetTop;
                            markerElement.style.left = data.x + targetLeft;
                            markerElement.style.width = data.width-2;
                            markerElement.style.height = data.height-2;
                            markerElement.style.display = "block";
                        });
                    }
                } else {
                    var imageElementWidth = imageElement.width;
                    var imageElementHeight = imageElement.height;
                    var ctx = imageElement.getContext("2d");
                    ctx.clearRect(0, 0, imageElementWidth, imageElementHeight);

                    fastdom.mutate(function() {

                        nameElement.innerText = "";
                        sizeElement.innerText = "";
                        markerElement.style.display = "none";
                    });
                }
            });
        }

        document.addEventListener("DOMContentLoaded", initialize);

    </script>
    <style>
        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        .infoPanel {
            float: left;
            width: 15em;
        }

        .fieldHeader {
            font-weight: bold;
        }

        .field {
            min-height: 1.2em;
            width: 15em;
            -moz-box-shadow: 0 0 5px #fff;
            -webkit-box-shadow: 0 0 5px #fff;
            box-shadow: 0px 0px 5px #fff;
        }

        #name {
            min-height: 2.4em;
        }

        #marker {
            border: 1px solid red;
            position: absolute;
        }

        #singleImage {
            width: 128px;
            height: 128px;
            border: 1px black solid;
        }

        #sheetContainer {
            width: calc(100% - 17em);
            left: 17em;
            height: calc(100% - 4em);
            position: absolute;
            overflow: scroll;
        }
    </style>
</head>
<body>

<div id="header">
    <div id="loading"><h1>Loading...</h1></div>
    <div id="headerContainer">
        <h1><a href="https://github.com/mezz/TextureDump">Texture Dump</a></h1>
    </div>
    <div id="name"></div>
</div>

<div id="sheetContainer">
    <div id="marker"></div>
    <image id="sheet" src="[textureName].png" />
</div>

<div class="infoPanel">
    <div class="fieldHeader">Mod ID: </div>
    <div id="modId" class="field"></div>
    <div class="fieldHeader">Size: </div>
    <div id="size" class="field"></div>
    <canvas id="singleImage"></canvas>
    <div id="debug" class="field"></div>
</div>
<script language="JavaScript">
    var imageData = [textureData];
</script>
</body>
</html>
